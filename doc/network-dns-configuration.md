# 网络DNS配置

## 概述

nix-operator 现在支持在网络接口配置中直接配置DNS nameservers，这是现代Linux系统推荐的方式，替代了传统的 `/etc/resolv.conf` 配置方法。

## 配置方式

### 在接口配置中添加DNS

```yaml
spec:
  network:
    interfaces:
      - name: "eth0"
        ipAddress: "192.168.1.100/24"
        gateway: "192.168.1.1"
        nameservers:
          - "8.8.8.8"
          - "8.8.4.4"
          - "2001:4860:4860::8888"  # IPv6 DNS
```

## 实现架构

### 模板系统

nix-operator 使用Go template系统来生成配置文件，提供了以下优势：

1. **可读性**: 模板清晰地展示了配置文件的结构
2. **可维护性**: 易于修改和扩展配置格式
3. **类型安全**: 使用结构化数据而非字符串拼接
4. **条件逻辑**: 支持复杂的条件判断和循环

### 支持的网络管理器

#### 1. Netplan (Ubuntu 18.04+)
使用结构化YAML生成，支持完整的netplan配置格式：

生成的配置示例：
```yaml
# Generated by nix-operator. DO NOT EDIT.
network:
  version: 2
  ethernets:
    eth0:
      addresses: ["192.168.1.100/24"]
      gateway4: "192.168.1.1"
      nameservers:
        addresses: ["8.8.8.8", "8.8.4.4"]
      mtu: 1500
```

**实现特点**:
- 使用Go结构体定义配置格式
- 自动处理可选字段（omitempty）
- 类型安全的YAML序列化

#### 2. NetworkManager (RHEL/CentOS/Fedora)
使用Go template生成INI格式配置：

```go
const nmConnectionTemplate = `{{.CommentHeader}}[connection]
id={{.Interface.Name}}
type=ethernet
interface-name={{.Interface.Name}}

[ipv4]
{{- if .Interface.IPAddress}}
address1={{.Interface.IPAddress}}
method=manual
{{- if .Interface.Gateway}}
gateway={{.Interface.Gateway}}
{{- end}}
{{- else}}
method=disabled
{{- end}}
{{- if .Interface.Nameservers}}
dns={{join .Interface.Nameservers ";"}}
{{- end}}
`
```

生成的配置示例：
```ini
# Generated by nix-operator. DO NOT EDIT.
[connection]
id=eth0
type=ethernet
interface-name=eth0

[ipv4]
address1=192.168.1.100/24
method=manual
gateway=192.168.1.1
dns=8.8.8.8;8.8.4.4

[ipv6]
method=disabled
```

#### 3. ifupdown (Debian/Ubuntu传统方式)
使用Go template生成传统interfaces格式：

```go
const ifupdownTemplate = `{{.CommentHeader}}auto {{.Interface.Name}}
{{- if .Interface.IPAddress}}
iface {{.Interface.Name}} inet static
    address {{.Interface.IPAddress}}
{{- if .Interface.Gateway}}
    gateway {{.Interface.Gateway}}
{{- end}}
{{- if .Interface.Nameservers}}
    dns-nameservers {{join .Interface.Nameservers " "}}
{{- end}}
{{- end}}
`
```

生成的配置示例：
```
# Generated by nix-operator. DO NOT EDIT.
auto eth0
iface eth0 inet static
    address 192.168.1.100/24
    gateway 192.168.1.1
    dns-nameservers 8.8.8.8 8.8.4.4
    mtu 1500
```

## 优势

1. **现代化**: 符合现代Linux发行版的网络配置标准
2. **统一管理**: DNS配置与网络接口配置在同一个地方
3. **自动应用**: 网络配置变更时DNS设置自动生效
4. **多管理器支持**: 自动检测并为所有已安装的网络管理器生成配置
5. **IPv6支持**: 原生支持IPv6 DNS服务器
6. **模板化**: 使用Go template提高代码可读性和可维护性
7. **类型安全**: 结构化配置避免字符串拼接错误

## 推荐的DNS服务器

### 公共DNS服务器
- **Google DNS**: `8.8.8.8`, `8.8.4.4`
- **Cloudflare DNS**: `1.1.1.1`, `1.0.0.1`
- **阿里云DNS**: `223.5.5.5`, `223.6.6.6`
- **腾讯DNS**: `119.29.29.29`, `182.254.116.116`

### IPv6 DNS服务器
- **Google IPv6**: `2001:4860:4860::8888`, `2001:4860:4860::8844`
- **Cloudflare IPv6**: `2606:4700:4700::1111`, `2606:4700:4700::1001`

## 注意事项

1. **不再使用 /etc/resolv.conf**: 现代网络管理器会自动管理此文件
2. **多接口DNS**: 如果多个接口都配置了DNS，系统会合并使用
3. **优先级**: 通常第一个配置的接口的DNS服务器优先级更高
4. **重启生效**: 配置变更后会自动重新加载网络配置
5. **模板验证**: 配置生成前会进行模板语法验证

